name: CI/CD - Test, Build, Deploy & Monitor

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  # --- ğŸ§ª Ã‰tape 1 : ExÃ©cution des tests unitaires ---
  test:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Cloner le repo
      uses: actions/checkout@v2

    - name: ğŸ›  Installer Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'

    - name: ğŸ“¦ Installer les dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest coverage

    - name: ğŸš€ ExÃ©cuter les tests avec pytest
      run: |
        pytest --maxfail=1 --disable-warnings -q

    - name: ğŸ“Š GÃ©nÃ©rer le rapport de couverture
      run: |
        coverage run -m pytest
        coverage report -m

  # --- ğŸ“Š Ã‰tape 2 : EntraÃ®nement et Ã‰valuation du ModÃ¨le ---
  train:
    needs: test  # Cette Ã©tape ne s'exÃ©cute que si les tests rÃ©ussissent
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Cloner le repo
      uses: actions/checkout@v2

    - name: ğŸ›  Installer Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'

    - name: ğŸ“¦ Installer les dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ”¥ EntraÃ®ner le modÃ¨le
      run: |
        python scripts/train_model.py  # VÃ©rifie que ce fichier existe

    - name: ğŸ“Š GÃ©nÃ©rer le rapport dâ€™Ã©valuation
      run: |
        python scripts/evaluate_model.py > reports/model_report.txt

    - name: ğŸ“¤ Sauvegarder le modÃ¨le entraÃ®nÃ©
      uses: actions/upload-artifact@v3
      with:
        name: trained_model
        path: models/

  # --- ğŸ³ Ã‰tape 3 : Construction et Push de l'Image Docker ---
  build_and_push:
    needs: train
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Cloner le repo
      uses: actions/checkout@v2

    - name: ğŸ›  Construire lâ€™image Docker
      run: |
        docker build -t monprojet/ia-api:latest .

    - name: ğŸ“¤ Pousser lâ€™image vers DockerHub
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        docker tag monprojet/ia-api:latest monprojet/ia-api:v1.0
        docker push monprojet/ia-api:v1.0

  # --- ğŸš€ Ã‰tape 4 : DÃ©ploiement sur Serveur ---
  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ Se connecter au serveur via SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}

    - name: ğŸš€ DÃ©ployer lâ€™application
      run: |
        docker pull monprojet/ia-api:v1.0
        docker-compose down
        docker-compose up -d

  # --- ğŸ” Ã‰tape 5 : VÃ©rification des mÃ©triques et monitoring ---
  monitor:
    needs: deploy
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“Š VÃ©rifier l'Ã©tat des mÃ©triques Prometheus
      run: |
        curl -X GET http://localhost:8000/metrics
